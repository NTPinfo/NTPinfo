

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>server.app.services.api_services &mdash; NTPinfo  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=82d09745" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            NTPinfo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.backend.html">Back-end component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.frontend.html">Front-end component</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">NTPinfo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">server.app.services.api_services</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for server.app.services.api_services</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.location_resolver</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_country_for_ip</span><span class="p">,</span> <span class="n">get_coordinates_for_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">sanitize_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.MeasurementRequest</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeasurementRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.analyze_ntp_versions</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_tool_on_ntp_version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.full_ntp_measurement</span><span class="w"> </span><span class="kn">import</span> <span class="n">NTSMeasurement</span><span class="p">,</span> <span class="n">FullMeasurementDN</span><span class="p">,</span> <span class="n">NTPv4Measurement</span><span class="p">,</span> <span class="n">NTPv5Measurement</span><span class="p">,</span> \
    <span class="n">put_fields_ntpv4</span><span class="p">,</span> <span class="n">put_fields_ntpv5</span><span class="p">,</span> <span class="n">put_fields_4_or_5</span><span class="p">,</span> <span class="n">NTPv4ServerInfo</span><span class="p">,</span> <span class="n">NTPv5ServerInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.AdvancedSettings</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdvancedSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.nts_check</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_nts_measurement_ip</span><span class="p">,</span> <span class="n">perform_nts_measurement_domain_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.full_ntp_measurement</span><span class="w"> </span><span class="kn">import</span> <span class="n">FullMeasurementIP</span><span class="p">,</span> <span class="n">NTPVersions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.ip_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_ip_family</span><span class="p">,</span> <span class="n">ref_id_to_ip_or_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.location_resolver</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_asn_for_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.ip_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_this_ip_anycast</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.perform_measurements</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_ntp_measurement_domain_name_list</span><span class="p">,</span> \
    <span class="n">analyze_supported_ntp_versions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.ip_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_server_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.models.CustomError</span><span class="w"> </span><span class="kn">import</span> <span class="n">InputError</span><span class="p">,</span> <span class="n">RipeMeasurementError</span><span class="p">,</span> <span class="n">DNSError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.load_config_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_nr_of_measurements_for_jitter</span><span class="p">,</span> \
    <span class="n">get_right_ntp_nts_binary_tool_for_your_os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.calculations</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_jitter_from_measurements</span><span class="p">,</span> <span class="n">human_date_to_ntp_precise_time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.ip_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ip_to_str</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.ripe_fetch_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_all_measurements_scheduled</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.perform_measurements</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_ripe_measurement_domain_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">ensure_utc</span><span class="p">,</span> <span class="n">is_ip_address</span><span class="p">,</span> <span class="n">parse_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.services.NtpCalculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">NtpCalculator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.perform_measurements</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_ntp_measurement_ip</span><span class="p">,</span> \
    <span class="n">perform_ripe_measurement_ip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.ProbeData</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerLocation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.RipeMeasurement</span><span class="w"> </span><span class="kn">import</span> <span class="n">RipeMeasurement</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.utils.ripe_fetch_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_data_from_ripe_measurement</span><span class="p">,</span> <span class="n">get_data_from_ripe_measurement</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.db.db_interaction</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert_measurement</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.db.db_interaction</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_measurements_timestamps_ip</span><span class="p">,</span> <span class="n">get_measurements_timestamps_dn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">server.app.dtos.NtpMeasurement</span><span class="w"> </span><span class="kn">import</span> <span class="n">NtpMeasurement</span>


<div class="viewcode-block" id="get_format">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.get_format">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_format</span><span class="p">(</span><span class="n">measurement</span><span class="p">:</span> <span class="n">NtpMeasurement</span><span class="p">,</span> <span class="n">jitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">nr_jitter_measurements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">get_nr_of_measurements_for_jitter</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format an NTP measurement object into a dictionary suitable for JSON serialization.</span>

<span class="sd">    Args:</span>
<span class="sd">        measurement (NtpMeasurement): An object representing the NTP measurement result</span>
<span class="sd">        jitter (Optional[float]): Optional jitter value if multiple measurements are performed</span>
<span class="sd">        nr_jitter_measurements (int): The number of measurements used in the jitter calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing key measurement details like this:</span>
<span class="sd">            - Server info (ntp version, IP, name, reference IP, reference)</span>
<span class="sd">            - Timestamps (client sent time, server receive time, server sent time, client receive time)</span>
<span class="sd">            - Measurement metrics (offset, delay, stratum, precision, reachability)</span>
<span class="sd">            - Extra details (root delay, last sync time, leap indicator)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;ntp_version&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_version</span><span class="p">,</span>
        <span class="s2">&quot;vantage_point_ip&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">vantage_point_ip</span><span class="p">),</span>
        <span class="s2">&quot;ntp_server_ip&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">),</span>
        <span class="s2">&quot;ntp_server_name&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_name</span><span class="p">,</span>
        <span class="s2">&quot;ntp_server_location&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ip_is_anycast&quot;</span><span class="p">:</span> <span class="n">is_this_ip_anycast</span><span class="p">(</span><span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">)),</span>
            <span class="s2">&quot;country_code&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_location</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_location</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="p">},</span>
        <span class="s2">&quot;ntp_server_ref_parent_ip&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ref_parent_ip</span><span class="p">),</span>
        <span class="s2">&quot;ref_name&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ref_name</span><span class="p">,</span>

        <span class="s2">&quot;client_sent_time&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_sent_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_sent_time</span><span class="o">.</span><span class="n">fraction</span>
        <span class="p">},</span>
        <span class="s2">&quot;server_recv_time&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_recv_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_recv_time</span><span class="o">.</span><span class="n">fraction</span>
        <span class="p">},</span>
        <span class="s2">&quot;server_sent_time&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_sent_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_sent_time</span><span class="o">.</span><span class="n">fraction</span>
        <span class="p">},</span>
        <span class="s2">&quot;client_recv_time&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_recv_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_recv_time</span><span class="o">.</span><span class="n">fraction</span>
        <span class="p">},</span>

        <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
        <span class="s2">&quot;rtt&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">rtt</span><span class="p">,</span>
        <span class="s2">&quot;stratum&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">stratum</span><span class="p">,</span>
        <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
        <span class="s2">&quot;reachability&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">reachability</span><span class="p">,</span>

        <span class="s2">&quot;root_delay&quot;</span><span class="p">:</span> <span class="n">NtpCalculator</span><span class="o">.</span><span class="n">calculate_float_time</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">root_delay</span><span class="p">),</span>
        <span class="s2">&quot;poll&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">poll</span><span class="p">,</span>
        <span class="s2">&quot;root_dispersion&quot;</span><span class="p">:</span> <span class="n">NtpCalculator</span><span class="o">.</span><span class="n">calculate_float_time</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">root_dispersion</span><span class="p">),</span>
        <span class="s2">&quot;asn_ntp_server&quot;</span><span class="p">:</span> <span class="n">get_asn_for_ip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">)),</span>
        <span class="s2">&quot;ntp_last_sync_time&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">ntp_last_sync_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
            <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">ntp_last_sync_time</span><span class="o">.</span><span class="n">fraction</span>
        <span class="p">},</span>
        <span class="c1"># if it has value = 3 =&gt; invalid</span>
        <span class="s2">&quot;leap&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">leap</span><span class="p">,</span>
        <span class="c1"># if the server has multiple IPs addresses we should show them to the client</span>
        <span class="s2">&quot;jitter&quot;</span><span class="p">:</span> <span class="n">jitter</span><span class="p">,</span>
        <span class="s2">&quot;nr_measurements_jitter&quot;</span><span class="p">:</span> <span class="n">nr_jitter_measurements</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="get_ripe_format">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.get_ripe_format">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ripe_format</span><span class="p">(</span><span class="n">measurement</span><span class="p">:</span> <span class="n">RipeMeasurement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a RipeMeasurement object into a standardized dictionary format.</span>

<span class="sd">        This function extracts relevant information from the provided RipeMeasurement</span>
<span class="sd">        instance—including NTP server info, probe data, timing details, and measurement</span>
<span class="sd">        results—and formats it as a plain dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            measurement (RipeMeasurement): The parsed measurement object containing NTP and probe data</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]:</span>
<span class="sd">                A dictionary containing structured measurement data. Keys include:</span>
<span class="sd">                - NTP Server info (ntp version, ripe measurement id, IP, name, ref id)</span>
<span class="sd">                - Probe data (probe address, probe id in RIPE Atlas, probe location, time to result)</span>
<span class="sd">                - Measurement metrics (stratum, poll, precision, root delay, root dispersion, reachability)</span>
<span class="sd">                - NTP measurement data (rtt, offset, timestamps)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">probe_location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ServerLocation</span><span class="p">]</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">probe_data</span><span class="o">.</span><span class="n">probe_location</span>
    <span class="c1"># this code regarding ref_id is because we need to consider IPv6 cases (M5 hashes involved)</span>
    <span class="n">ref_id_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;NO REFERENCE&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ref_ip</span><span class="p">,</span> <span class="n">ref_text</span> <span class="o">=</span> <span class="n">ref_id_to_ip_or_name</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ref_id</span><span class="p">),</span>
                                                <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">stratum</span><span class="p">,</span>
                                                <span class="n">get_ip_family</span><span class="p">(</span>
                                                    <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">ref_ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_id_str</span> <span class="o">=</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">ref_ip</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ref_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_id_str</span> <span class="o">=</span> <span class="n">ref_text</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># if ref_id could not be converted to an integer (ex: it was already a str)</span>
        <span class="n">ref_id_str</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ref_id</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;ntp_version&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_version</span><span class="p">,</span>
        <span class="s2">&quot;vantage_point_ip&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">vantage_point_ip</span><span class="p">),</span>
        <span class="s2">&quot;ripe_measurement_id&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">measurement_id</span><span class="p">,</span>
        <span class="s2">&quot;ntp_server_ip&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">),</span>
        <span class="s2">&quot;ntp_server_name&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_name</span><span class="p">,</span>
        <span class="s2">&quot;ntp_server_location&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ip_is_anycast&quot;</span><span class="p">:</span> <span class="n">is_this_ip_anycast</span><span class="p">(</span><span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">)),</span>
            <span class="s2">&quot;country_code&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_location</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_location</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="p">},</span>
        <span class="s2">&quot;probe_addr&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ipv4&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">probe_data</span><span class="o">.</span><span class="n">probe_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s2">&quot;ipv6&quot;</span><span class="p">:</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">probe_data</span><span class="o">.</span><span class="n">probe_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">},</span>
        <span class="s2">&quot;probe_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">probe_data</span><span class="o">.</span><span class="n">probe_id</span><span class="p">),</span>
        <span class="s2">&quot;probe_location&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;country_code&quot;</span><span class="p">:</span> <span class="n">probe_location</span><span class="o">.</span><span class="n">country_code</span> <span class="k">if</span> <span class="n">probe_location</span> <span class="k">else</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">probe_location</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">if</span> <span class="n">probe_location</span> <span class="k">else</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;time_to_result&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">time_to_result</span><span class="p">,</span>
        <span class="s2">&quot;stratum&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">stratum</span><span class="p">,</span>
        <span class="s2">&quot;poll&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">poll</span><span class="p">,</span>
        <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
        <span class="s2">&quot;root_delay&quot;</span><span class="p">:</span> <span class="n">NtpCalculator</span><span class="o">.</span><span class="n">calculate_float_time</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">root_delay</span><span class="p">),</span>
        <span class="s2">&quot;root_dispersion&quot;</span><span class="p">:</span> <span class="n">NtpCalculator</span><span class="o">.</span><span class="n">calculate_float_time</span><span class="p">(</span>
            <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">extra_details</span><span class="o">.</span><span class="n">root_dispersion</span><span class="p">),</span>
        <span class="s2">&quot;asn_ntp_server&quot;</span><span class="p">:</span> <span class="n">get_asn_for_ip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ip</span><span class="p">)),</span>
        <span class="s2">&quot;ref_id&quot;</span><span class="p">:</span> <span class="n">ref_id_str</span><span class="p">,</span>
        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;client_sent_time&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_sent_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_sent_time</span><span class="o">.</span><span class="n">fraction</span>
                <span class="p">},</span>
                <span class="s2">&quot;server_recv_time&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_recv_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_recv_time</span><span class="o">.</span><span class="n">fraction</span>
                <span class="p">},</span>
                <span class="s2">&quot;server_sent_time&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_sent_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">server_sent_time</span><span class="o">.</span><span class="n">fraction</span>
                <span class="p">},</span>
                <span class="s2">&quot;client_recv_time&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_recv_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">,</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">client_recv_time</span><span class="o">.</span><span class="n">fraction</span>
                <span class="p">},</span>
                <span class="s2">&quot;rtt&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">rtt</span><span class="p">,</span>
                <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">measurement</span><span class="o">.</span><span class="n">ntp_measurement</span><span class="o">.</span><span class="n">main_details</span><span class="o">.</span><span class="n">offset</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="override_desired_ip_type_if_input_is_ip">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.override_desired_ip_type_if_input_is_ip">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">override_desired_ip_type_if_input_is_ip</span><span class="p">(</span><span class="n">target_server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wanted_ip_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the target server input is IP, then we want to perform its IP type measurements.</span>
<span class="sd">    Only for domain names, &quot;wanted_ip_type&quot; is considered. Otherwise, it is ignored.</span>

<span class="sd">    Args:</span>
<span class="sd">        target_server (str): The server we want to measure (domain name or IP address)</span>
<span class="sd">        wanted_ip_type (int): The IP type the user said they wanted to measure.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The IP type of the server in case the server input is IP, otherwise the wanted_ip_type unmodified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">target_server</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ipv4&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">target_server</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ipv6&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">6</span>
    <span class="k">return</span> <span class="n">wanted_ip_type</span></div>



<div class="viewcode-block" id="measure">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.measure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">measure</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wanted_ip_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">measurement_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">get_nr_of_measurements_for_jitter</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span>
    <span class="n">NtpMeasurement</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs an NTP measurement for a given server (IP or domain name) and stores the result in the database.</span>

<span class="sd">    This function determines whether the input is an IP address or a domain name,</span>
<span class="sd">    then performs an NTP measurement using the appropriate method. The result is inserted</span>
<span class="sd">    into the database and returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        server (str): A string representing either an IPv4/IPv6 address or a domain name.</span>
<span class="sd">        wanted_ip_type (int): The IP type that we want to measure. Used for domain names.</span>
<span class="sd">        session (Session): The currently active database session.</span>
<span class="sd">        client_ip (Optional[str]): The client IP or None if it was not provided.</span>
<span class="sd">        measurement_no (int): How many extra measurements to perform if the jitter_flag is True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[tuple[NtpMeasurement, float, int]] | None:</span>
<span class="sd">            - A list of pairs with a populated `NtpMeasurement` object if the measurement is successful, and the jitter.</span>
<span class="sd">            - `None` if an exception occurs during the measurement process.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DNSError: If the domain name is invalid, or it could not be resolved.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - If the server string is empty or improperly formatted, this may raise exceptions internally,</span>
<span class="sd">          which are caught and logged to stdout.</span>
<span class="sd">        - This function modifies persistent state by inserting a measurement into the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">perform_ntp_measurement_ip</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jitter</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">nr_jitter_measurements</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">insert_measurement</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_jitter_from_measurements</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">measurement_no</span><span class="p">)</span>
                <span class="c1"># if result is not None:</span>
                <span class="n">jitter</span><span class="p">,</span> <span class="n">nr_jitter_measurements</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">nr_jitter_measurements</span><span class="p">)]</span>
            <span class="c1"># the measurement failed</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The ntp server &quot;</span> <span class="o">+</span> <span class="n">server</span> <span class="o">+</span> <span class="s2">&quot; is not responding.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">measurements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">NtpMeasurement</span><span class="p">]]</span> <span class="o">=</span> <span class="n">perform_ntp_measurement_domain_name_list</span><span class="p">(</span><span class="n">server</span><span class="p">,</span>
                                                                                                    <span class="n">client_ip</span><span class="p">,</span>
                                                                                                    <span class="n">wanted_ip_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">measurements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measurements</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">server_info</span><span class="o">.</span><span class="n">ntp_server_ref_parent_ip</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">:</span>
                        <span class="n">m_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="n">jitter</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">nr_jitter_measurements</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">insert_measurement</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_jitter_from_measurements</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">measurement_no</span><span class="p">)</span>
                    <span class="c1"># if result is not None:</span>
                    <span class="n">jitter</span><span class="p">,</span> <span class="n">nr_jitter_measurements</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="n">m_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">nr_jitter_measurements</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">m_results</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The ntp server &quot;</span> <span class="o">+</span> <span class="n">server</span> <span class="o">+</span> <span class="s2">&quot; is not responding.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">DNSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing measurement error message:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing measurement error message:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="check_and_get_settings">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.check_and_get_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_and_get_settings</span><span class="p">(</span><span class="n">input_settings</span><span class="p">:</span> <span class="n">MeasurementRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdvancedSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method takes the parameters that the client inputted. It checks them and it returns the settings.</span>
<span class="sd">    Args:</span>
<span class="sd">        input_settings (MeasurementRequest): The parameters that the client inputted.</span>
<span class="sd">    Returns:</span>
<span class="sd">        AdvancedSettings: The settings to be used internally in the server. (valid settings)</span>
<span class="sd">    Raises:</span>
<span class="sd">        InputError: If some settings are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wanted_ip_type</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ipv6_measurement</span> <span class="k">else</span> <span class="mi">4</span>
    <span class="c1"># Override it if we received an IP, not a domain name:</span>
    <span class="c1"># In case the input is an IP and not a domain name, then &quot;wanted_ip_type&quot; will be ignored and the IP type of the IP will be used.</span>
    <span class="n">input_settings</span><span class="o">.</span><span class="n">wanted_ip_type</span> <span class="o">=</span> <span class="n">override_desired_ip_type_if_input_is_ip</span><span class="p">(</span><span class="n">input_settings</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">wanted_ip_type</span><span class="p">)</span>
    <span class="c1"># create the settings (get rid of None-s)</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">AdvancedSettings</span><span class="p">(</span><span class="n">wanted_ip_type</span><span class="o">=</span><span class="n">wanted_ip_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">measurement_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">measurement_type</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">measurement_type</span>

    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span>
    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">analyse_all_ntp_versions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">analyse_all_ntp_versions</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">analyse_all_ntp_versions</span>
    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ntp_versions_analysis_on_each_ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_analysis_on_each_ip</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ntp_versions_analysis_on_each_ip</span>
    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">nts_analysis_on_each_ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">nts_analysis_on_each_ip</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">nts_analysis_on_each_ip</span>

    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ntpv5_draft</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">ntpv5_draft</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">ntpv5_draft</span>

    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">custom_probes_asn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">custom_probes_asn</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">custom_probes_asn</span>
    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">custom_probes_country</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">custom_probes_country</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">custom_probes_country</span>
    <span class="k">if</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">custom_client_ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">custom_client_ip</span> <span class="o">=</span> <span class="n">input_settings</span><span class="o">.</span><span class="n">custom_client_ip</span>

    <span class="k">return</span> <span class="n">check_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_settings">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.check_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdvancedSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method checks the values in the settings.</span>
<span class="sd">    Args:</span>
<span class="sd">        settings (AdvancedSettings): The parameters that the client inputted.</span>
<span class="sd">    Returns:</span>
<span class="sd">        AdvancedSettings: The settings to be used internally in the server. (valid settings)</span>
<span class="sd">    Raises:</span>
<span class="sd">        InputError: If some settings are invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># checks</span>
    <span class="c1"># main measurement settings</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">wanted_ip_type</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">wanted_ip_type</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;wanted_ip_type must be 4 or 6&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">measurement_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ntpv1&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv2&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv3&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv4&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv5&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;measurement_type must be ntpv1 or ntpv2 or ntpv3 or ntpv4 or ntpv5&quot;</span><span class="p">)</span>
    <span class="c1"># ntp versions settings</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">measurement_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ntpv1&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv2&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv3&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv4&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv5&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;measurement_type must be either ntpv1 or ntpv2 or ntpv3 or ntpv4 or ntpv5&quot;</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">measurement_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ntpv1&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv2&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv3&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv4&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv5&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the version </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> must be either ntpv1 or ntpv2 or ntpv3 or ntpv4 or ntpv5&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">analyse_all_ntp_versions</span><span class="p">:</span>  <span class="c1"># if they want to measure everything, override the list</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ntpv1&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv2&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv3&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv4&quot;</span><span class="p">,</span> <span class="s2">&quot;ntpv5&quot;</span><span class="p">]</span>

    <span class="c1"># RIPE part</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">custom_client_ip</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">custom_client_ip</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;custom_client_ip must be either null/empty or a valid IP address&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">settings</span></div>



<div class="viewcode-block" id="complete_this_measurement_dn">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.complete_this_measurement_dn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">complete_this_measurement_dn</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dn_ips</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if the measurement_id is not in the database, then this method does nothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># very important: keep this &quot;import&quot; here (Because it needs to be imported after SQLAlchemy has been initialized)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">server.app.db_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">_SessionLocal</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting dn...</span><span class="si">{</span><span class="n">measurement_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_SessionLocal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this will never be the case. This code is to solve a mypy type error</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;_SessionLocal is None. No connection to the database&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">_SessionLocal</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span><span class="p">:</span> <span class="n">FullMeasurementDN</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FullMeasurementDN</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id_m_dn</span><span class="o">=</span><span class="n">measurement_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">server</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>

        <span class="c1"># RIPE PART</span>
        <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;starting RIPE measurement&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">add_ripe_measurement_id_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># delete the custom client ip</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">custom_client_ip</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># MAIN NTP measurement PART</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">dn_ips</span><span class="p">:</span>
            <span class="c1"># print(f&quot;ip:{ip}&quot;)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;adding ntp measurements </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dn_ips</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">measurement_ip</span> <span class="o">=</span> <span class="n">FullMeasurementIP</span><span class="p">(</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
                <span class="n">server_ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">measurement_ip</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">measurement_ip</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span>
            <span class="n">complete_this_measurement_ip</span><span class="p">(</span><span class="n">measurement_ip</span><span class="o">.</span><span class="n">id_m_ip</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">ip_measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measurement_ip</span><span class="p">)</span>
            <span class="c1"># NTP servers may refuse to respond if you poll them very often</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># NTS PART</span>
        <span class="c1"># no check because it is done by default</span>
        <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;adding nts&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nts_ans</span> <span class="o">=</span> <span class="n">perform_nts_measurement_domain_name</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="n">nts</span> <span class="o">=</span> <span class="n">NTSMeasurement</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">nts_ans</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>  <span class="c1"># currently we only support NTS with ntpv4</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">id_nts</span> <span class="o">=</span> <span class="n">nts</span><span class="o">.</span><span class="n">id_nts</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

        <span class="c1"># NTP Versions PART</span>
        <span class="c1"># check the settings -&gt; to see if the client wants NTP version analysis:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">analyse_all_ntp_versions</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># adding NTP versions analysis</span>
            <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;adding NTP versions analysis&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">add_ntp_versions_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

        <span class="c1"># add settings</span>
        <span class="n">m</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="c1"># Update with results</span>
        <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;finished&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Completing measurement error message:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FullMeasurementDN</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id_m_dn</span><span class="o">=</span><span class="n">measurement_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;finished&quot;</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                <span class="n">m</span><span class="o">.</span><span class="n">response_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(surprising) error when completing the measurement: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inner</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while marking failed:&quot;</span><span class="p">,</span> <span class="n">inner</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="complete_this_measurement_ip">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.complete_this_measurement_ip">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">complete_this_measurement_ip</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">,</span> <span class="n">part_of_dn_measurement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                 <span class="n">from_dn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if the measurement_id is not in the database, then this method does nothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># very important: keep this &quot;import&quot; here (Because it needs to be imported after SQLAlchemy has been initialized)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">server.app.db_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">_SessionLocal</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting ip...</span><span class="si">{</span><span class="n">measurement_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_SessionLocal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this will never be the case. This code is to solve a mypy type error</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;_SessionLocal is None. No connection to the database&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">_SessionLocal</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span><span class="p">:</span> <span class="n">FullMeasurementIP</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FullMeasurementIP</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id_m_ip</span><span class="o">=</span><span class="n">measurement_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">server_ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">server_ip</span><span class="p">)</span>
        <span class="c1"># m.status = &quot;starting&quot;</span>
        <span class="c1"># status = m.status</span>
        <span class="c1"># db.commit()</span>

        <span class="c1"># RIPE PART (only if it is not part of the domain name. In that case you can see it at domain name)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">part_of_dn_measurement</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;starting RIPE measurement&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">add_ripe_measurement_id_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="c1"># delete the custom client ip</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">custom_client_ip</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># MAIN NTP measurement PART</span>
        <span class="c1"># if it fails, you will see the error message in the m.response_error</span>
        <span class="n">add_custom_ntp_measurement_ip_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">from_dn</span><span class="p">)</span>

        <span class="c1"># NTS PART</span>
        <span class="c1"># if it is part of a dn measurement, you need to check if the client really wants on each IP address.</span>
        <span class="k">if</span> <span class="n">part_of_dn_measurement</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">nts_analysis_on_each_ip</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;adding nts&quot;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nts_ans</span> <span class="o">=</span> <span class="n">perform_nts_measurement_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">)</span>
            <span class="n">nts_ans</span><span class="p">[</span><span class="s2">&quot;warning_ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NTS measurements on IPs cannot check TLS certificate.&quot;</span>
            <span class="c1"># do not add from_dn here because NTS is special and KE of NTS may change the IP</span>
            <span class="n">nts</span> <span class="o">=</span> <span class="n">NTSMeasurement</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">nts_ans</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>  <span class="c1"># currently we only support NTS with ntpv4</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">id_nts</span> <span class="o">=</span> <span class="n">nts</span><span class="o">.</span><span class="n">id_nts</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

        <span class="c1"># NTP Versions PART</span>
        <span class="c1"># check the settings -&gt; to see if the client wants NTP version analysis:</span>
        <span class="c1"># if is not part of a dn measurement, then check as usual. But if it is, then &quot;analyse_all_ntp_versions&quot; and &quot;ntp_versions_to_analyze&quot;</span>
        <span class="c1"># are settings for the domain name. We need to look at &quot;nts_analysis_on_each_ip&quot; to see if the client also wants to apply the</span>
        <span class="c1"># settings on the IP addresses</span>
        <span class="k">if</span> <span class="n">part_of_dn_measurement</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_analysis_on_each_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">analyse_all_ntp_versions</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ntp_versions_to_analyze</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># adding NTP versions analysis</span>
                <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;adding NTP versions analysis&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># to make sure the server would not blacklist us</span>
                <span class="n">add_ntp_versions_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">from_dn</span><span class="p">)</span>
        <span class="c1"># add settings</span>
        <span class="n">m</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="c1"># Update with results</span>
        <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;finished&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">take_care_of_exception</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">measurement_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="take_care_of_exception">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.take_care_of_exception">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">take_care_of_exception</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">measurement_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ip_measurement</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method takes care of marking the measurement as failed, if something happened.</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database (we need to query some IDs).</span>
<span class="sd">        e (Exception): An exception instance.</span>
<span class="sd">        measurement_id (int): The measurement id.</span>
<span class="sd">        ip_measurement (bool): Whether the measurement was on an IP address.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Completing measurement error message:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FullMeasurementIP</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id_m_ip</span><span class="o">=</span><span class="n">measurement_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;finished&quot;</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
            <span class="n">m</span><span class="o">.</span><span class="n">response_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(surprising) error when completing the measurement: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inner</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while marking failed:&quot;</span><span class="p">,</span> <span class="n">inner</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_custom_ntp_measurement_ip_to_db_measurement">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.add_custom_ntp_measurement_ip_to_db_measurement">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_custom_ntp_measurement_ip_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">,</span>
                                                    <span class="n">full_m</span><span class="p">:</span> <span class="n">FullMeasurementIP</span><span class="p">,</span> <span class="n">from_dn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method is used when you performed a full measurement on an IP address.</span>
<span class="sd">    If the measurement fails, you will not see why in the full_m.response_error</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database (we need to query some IDs)</span>
<span class="sd">        server_ip (str): The IP address of the server.</span>
<span class="sd">        settings (AdvancedSettings): The settings to use.</span>
<span class="sd">        full_m (FullMeasurementIP): Full measurement IP object.</span>
<span class="sd">        from_dn (Optional[str]): The domain name of this IP address, if available. (it will simplify the</span>
<span class="sd">                process of searching in the db)</span>
<span class="sd">    Returns:</span>
<span class="sd">        None: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">binary_nts_tool</span> <span class="o">=</span> <span class="n">get_right_ntp_nts_binary_tool_for_your_os</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># This is the case when the tool fails, because python was not able to find it or run it.</span>
        <span class="n">full_m</span><span class="o">.</span><span class="n">response_error</span> <span class="o">=</span> <span class="s2">&quot;Measurement could not be performed (binary tool not available).&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conf</span><span class="p">,</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">run_tool_on_ntp_version</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">binary_nts_tool</span><span class="p">),</span>
                                                       <span class="n">settings</span><span class="o">.</span><span class="n">measurement_type</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ntpv5_draft</span><span class="p">)</span>

        <span class="c1"># 3 cases:</span>
        <span class="c1"># 1 we received a real wanted ntp version</span>
        <span class="c1"># 2 we received a fake wanted ntp version</span>
        <span class="c1"># 3 we received a real different ntp version</span>
        <span class="c1"># the client will see the results</span>
        <span class="c1"># as what class do we save it? -&gt;</span>
        <span class="c1"># save as what the response version says</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">server_ip</span>
        <span class="k">if</span> <span class="n">from_dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">from_dn</span>
        <span class="c1"># the decision was based on these statements:</span>
        <span class="c1"># it is ok if in NTPv5 class we have fake measurements that says their version is NTPv5</span>
        <span class="c1">#  which is the ntp server&#39;s problem, not ours-&gt; we can easily detect them</span>
        <span class="c1"># it is not ok if in NTPv5 class we have correct NTPv4 measurements</span>
        <span class="n">response_version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">))</span>
        <span class="c1"># in case the measurement failed (you can also see that the conf is &quot;0&quot;)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">full_m</span><span class="o">.</span><span class="n">response_error</span> <span class="o">=</span> <span class="n">analysis</span>
            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">response_version</span> <span class="o">!=</span> <span class="s2">&quot;5&quot;</span> <span class="ow">and</span> <span class="n">response_version</span> <span class="o">!=</span> <span class="s2">&quot;ntpv5&quot;</span><span class="p">:</span>  <span class="c1"># I think this may help if someone is confused about notations.</span>
            <span class="c1"># then it is either NTPv1,v2,v3 or v4. But all of them are saved in the database in the NTPv4 format.</span>
            <span class="c1"># add the &quot;from_dn&quot; in case it exists.</span>
            <span class="n">measurement_v</span> <span class="o">=</span> <span class="n">NTPv4Measurement</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">measured_server_ip</span><span class="o">=</span><span class="n">server_ip</span><span class="p">)</span>
            <span class="n">put_fields_ntpv4</span><span class="p">(</span><span class="n">measurement_v</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">analysis</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">measurement_v</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># add the server info</span>
            <span class="n">get_server_info_objectv4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">measurement_v</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
            <span class="n">full_m</span><span class="o">.</span><span class="n">id_main_measurement</span> <span class="o">=</span> <span class="n">measurement_v</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">measurement_v5</span> <span class="o">=</span> <span class="n">NTPv5Measurement</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">measured_server_ip</span><span class="o">=</span><span class="n">server_ip</span><span class="p">)</span>
            <span class="n">put_fields_ntpv5</span><span class="p">(</span><span class="n">measurement_v5</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ntpv5_draft</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">measurement_v5</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># add the server info</span>
            <span class="n">get_server_info_objectv5</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">measurement_v5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
            <span class="n">full_m</span><span class="o">.</span><span class="n">id_main_measurement</span> <span class="o">=</span> <span class="n">measurement_v5</span><span class="o">.</span><span class="n">id</span>
        <span class="n">full_m</span><span class="o">.</span><span class="n">response_version</span> <span class="o">=</span> <span class="s2">&quot;ntpv&quot;</span> <span class="o">+</span> <span class="n">response_version</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># we arrive here iff run_tool_on_ntp_version throws an error</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error in adding custom ntp measurement:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_server_info_objectv4">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.get_server_info_objectv4">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_server_info_objectv4</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">m_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the server info object fot this measurement.</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database (we need to query some IDs).</span>
<span class="sd">        m_id (int): The measurement (NTPv4 class) id.</span>
<span class="sd">        server_ip (Optional[str]): The IP address of the server.</span>
<span class="sd">    Returns:</span>
<span class="sd">         None: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msi</span> <span class="o">=</span> <span class="n">NTPv4ServerInfo</span><span class="p">(</span><span class="n">m_id</span><span class="o">=</span><span class="n">m_id</span><span class="p">,</span> <span class="n">ip_is_anycast</span><span class="o">=</span><span class="n">is_this_ip_anycast</span><span class="p">(</span><span class="n">server_ip</span><span class="p">),</span>
                          <span class="n">asn_ntp_server</span><span class="o">=</span><span class="n">get_asn_for_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">),</span> <span class="n">country_code</span><span class="o">=</span><span class="n">get_country_for_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">))</span>
    <span class="n">msi</span><span class="o">.</span><span class="n">vantage_point_ip</span> <span class="o">=</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">get_server_ip</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_coordinates_for_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msi</span><span class="o">.</span><span class="n">coordinates_x</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msi</span><span class="o">.</span><span class="n">coordinates_y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msi</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_server_info_objectv5">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.get_server_info_objectv5">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_server_info_objectv5</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">m_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the server info object fot this measurement.</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database (we need to query some IDs).</span>
<span class="sd">        m_id (int): The measurement (NTPv5 class) id.</span>
<span class="sd">        server_ip (Optional[str]): The IP address of the server.</span>
<span class="sd">    Returns:</span>
<span class="sd">         None: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msi</span> <span class="o">=</span> <span class="n">NTPv5ServerInfo</span><span class="p">(</span><span class="n">m_id</span><span class="o">=</span><span class="n">m_id</span><span class="p">,</span> <span class="n">ip_is_anycast</span><span class="o">=</span><span class="n">is_this_ip_anycast</span><span class="p">(</span><span class="n">server_ip</span><span class="p">),</span>
                          <span class="n">asn_ntp_server</span><span class="o">=</span><span class="n">get_asn_for_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">),</span> <span class="n">country_code</span><span class="o">=</span><span class="n">get_country_for_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">))</span>
    <span class="n">msi</span><span class="o">.</span><span class="n">vantage_point_ip</span> <span class="o">=</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">get_server_ip</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_coordinates_for_ip</span><span class="p">(</span><span class="n">server_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msi</span><span class="o">.</span><span class="n">coordinates_x</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msi</span><span class="o">.</span><span class="n">coordinates_y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msi</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_host_and_server_ip">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.get_host_and_server_ip">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_host_and_server_ip</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">from_dn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method gets the host and server IP. It is useful because it can work with both cases: domain name and IP address</span>
<span class="sd">    Args:</span>
<span class="sd">        server (str): The server name. (ip or dn)</span>
<span class="sd">        from_dn (Optional[str]): The domain name of this IP address.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple[str, Optional[str]]: The host and server IP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">server</span>
    <span class="n">server_ip</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
        <span class="n">server_ip</span> <span class="o">=</span> <span class="n">server</span>
    <span class="k">if</span> <span class="n">from_dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">from_dn</span>
    <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span></div>



<div class="viewcode-block" id="add_ntp_versions_to_db_measurement">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.add_ntp_versions_to_db_measurement">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_ntp_versions_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">,</span>
                                       <span class="n">m</span><span class="p">:</span> <span class="n">FullMeasurementDN</span> <span class="o">|</span> <span class="n">FullMeasurementIP</span><span class="p">,</span> <span class="n">from_dn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method adds the ntp versions analysis to the database and to the measurement.</span>
<span class="sd">    If this fails, then the ID for this measurement will be None/Null when the status of the overall</span>
<span class="sd">    measurement will be &quot;finished&quot;.</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database (we need to query some IDs)</span>
<span class="sd">        server (str): The server (IP address or domain name)</span>
<span class="sd">        settings (AdvancedSettings): The settings to use.</span>
<span class="sd">        m (FullMeasurementDN | FullMeasurementIP): Full measurement IP object.</span>
<span class="sd">        from_dn (Optional[str]): The domain name of this IP address, if available.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span> <span class="o">=</span> <span class="n">get_host_and_server_ip</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">from_dn</span><span class="o">=</span><span class="n">from_dn</span><span class="p">)</span>
    <span class="c1"># print(f&quot;ntpv: host: {host}, ip: {server_ip}&quot;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ntpv_ans</span> <span class="o">=</span> <span class="n">analyze_supported_ntp_versions</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c1"># if there is an error with our tool (not the results from our tool! Important difference)</span>
        <span class="k">if</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># !!! IMPORTANT !!!</span>
        <span class="c1"># if for example you wanted an NTPv5 measurement, but you received an NTPv4 response, then it will be saved</span>
        <span class="c1"># as NTPv4 in our databases, and the whole situation will be highlighted in the NTPVersions. This is because we</span>
        <span class="c1"># want to avoid having versions in the wrong place.</span>
        <span class="c1"># On the other hand, we may end with &quot;fake&quot; NTPv5 measurements if a server replies with NTPv4 response, but has set</span>
        <span class="c1"># the version to NTPv4. But this is exactly the scope of this tool! To spot mistakes in the NTP servers behaviours.</span>
        <span class="n">ntp_vs</span> <span class="o">=</span> <span class="n">NTPVersions</span><span class="p">(</span><span class="n">ntpv1_supported_conf</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv1_supported_confidence&quot;</span><span class="p">),</span>
                             <span class="n">ntpv2_supported_conf</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv2_supported_confidence&quot;</span><span class="p">),</span>
                             <span class="n">ntpv3_supported_conf</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv3_supported_confidence&quot;</span><span class="p">),</span>
                             <span class="n">ntpv4_supported_conf</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv4_supported_confidence&quot;</span><span class="p">),</span>
                             <span class="n">ntpv5_supported_conf</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv5_supported_confidence&quot;</span><span class="p">),</span>
                             <span class="n">ntpv1_analysis</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv1_analysis&quot;</span><span class="p">),</span>
                             <span class="n">ntpv2_analysis</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv2_analysis&quot;</span><span class="p">),</span>
                             <span class="n">ntpv3_analysis</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv3_analysis&quot;</span><span class="p">),</span>
                             <span class="n">ntpv4_analysis</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv4_analysis&quot;</span><span class="p">),</span>
                             <span class="n">ntpv5_analysis</span><span class="o">=</span><span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv5_analysis&quot;</span><span class="p">),</span>
                             <span class="c1"># we will add the results immediately (and their response versions)</span>
                             <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ntp_vs</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># assign ID without commit yet</span>

        <span class="c1"># insert measurements</span>
        <span class="n">ntpv1</span><span class="p">,</span> <span class="n">resp1_vs</span> <span class="o">=</span> <span class="n">add_ntp_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv1_m_result&quot;</span><span class="p">),</span> <span class="n">settings</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
        <span class="n">ntpv2</span><span class="p">,</span> <span class="n">resp2_vs</span> <span class="o">=</span> <span class="n">add_ntp_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv2_m_result&quot;</span><span class="p">),</span> <span class="n">settings</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
        <span class="n">ntpv3</span><span class="p">,</span> <span class="n">resp3_vs</span> <span class="o">=</span> <span class="n">add_ntp_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv3_m_result&quot;</span><span class="p">),</span> <span class="n">settings</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
        <span class="n">ntpv4</span><span class="p">,</span> <span class="n">resp4_vs</span> <span class="o">=</span> <span class="n">add_ntp_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv4_m_result&quot;</span><span class="p">),</span> <span class="n">settings</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
        <span class="n">ntpv5</span><span class="p">,</span> <span class="n">resp5_vs</span> <span class="o">=</span> <span class="n">add_ntp_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv5_m_result&quot;</span><span class="p">),</span> <span class="n">settings</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>

        <span class="c1"># link them if they exist</span>
        <span class="k">if</span> <span class="n">ntpv1</span><span class="p">:</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">id_v4_1</span> <span class="o">=</span> <span class="n">ntpv1</span><span class="o">.</span><span class="n">id</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">ntpv1_response_version</span> <span class="o">=</span> <span class="n">resp1_vs</span>
            <span class="n">put_fields_4_or_5</span><span class="p">(</span><span class="n">ntpv1</span><span class="p">,</span> <span class="n">resp1_vs</span><span class="p">,</span>
                              <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv1_m_result&quot;</span><span class="p">))</span>  <span class="c1"># , ntpv_ans.get(&quot;ntpv1_analysis&quot;) # redundant dat</span>
        <span class="k">if</span> <span class="n">ntpv2</span><span class="p">:</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">id_v4_2</span> <span class="o">=</span> <span class="n">ntpv2</span><span class="o">.</span><span class="n">id</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">ntpv2_response_version</span> <span class="o">=</span> <span class="n">resp2_vs</span>
            <span class="n">put_fields_4_or_5</span><span class="p">(</span><span class="n">ntpv2</span><span class="p">,</span> <span class="n">resp2_vs</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv2_m_result&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ntpv3</span><span class="p">:</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">id_v4_3</span> <span class="o">=</span> <span class="n">ntpv3</span><span class="o">.</span><span class="n">id</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">ntpv3_response_version</span> <span class="o">=</span> <span class="n">resp3_vs</span>
            <span class="n">put_fields_4_or_5</span><span class="p">(</span><span class="n">ntpv3</span><span class="p">,</span> <span class="n">resp3_vs</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv3_m_result&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ntpv4</span><span class="p">:</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">id_v4_4</span> <span class="o">=</span> <span class="n">ntpv4</span><span class="o">.</span><span class="n">id</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">ntpv4_response_version</span> <span class="o">=</span> <span class="n">resp4_vs</span>
            <span class="n">put_fields_4_or_5</span><span class="p">(</span><span class="n">ntpv4</span><span class="p">,</span> <span class="n">resp4_vs</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv4_m_result&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ntpv5</span><span class="p">:</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">id_v5</span> <span class="o">=</span> <span class="n">ntpv5</span><span class="o">.</span><span class="n">id</span>
            <span class="n">ntp_vs</span><span class="o">.</span><span class="n">ntpv5_response_version</span> <span class="o">=</span> <span class="n">resp5_vs</span>
            <span class="n">put_fields_4_or_5</span><span class="p">(</span><span class="n">ntpv5</span><span class="p">,</span> <span class="n">resp5_vs</span><span class="p">,</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv5_m_result&quot;</span><span class="p">),</span> <span class="n">ntpv_ans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ntpv5_analysis&quot;</span><span class="p">),</span>
                              <span class="n">settings</span><span class="o">.</span><span class="n">ntpv5_draft</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">id_vs</span> <span class="o">=</span> <span class="n">ntp_vs</span><span class="o">.</span><span class="n">id_vs</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">ntp_vs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error in adding ntp versions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_ntp_measurement">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.add_ntp_measurement">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_ntp_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">server_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> \
        <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">NTPv4Measurement</span> <span class="o">|</span> <span class="n">NTPv5Measurement</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method adds the result (NTP measurement) into the database.</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database.</span>
<span class="sd">        result (Optional[dict]): the result of the adding NTP measurement</span>
<span class="sd">        settings (AdvancedSettings): the settings to use</span>
<span class="sd">        host (Optional[str]): the host to use (IP or domain name)</span>
<span class="sd">        server_ip (Optional[str]): the IP</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Optional[NTPv4Measurement | NTPv5Measurement], Optional[str]]: A pair of the measurement and its version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># result = ntpv_ans.get(result_key)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">):</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="s2">&quot;ntpv4&quot;</span>
        <span class="n">measurement_vs</span><span class="p">:</span> <span class="n">NTPv5Measurement</span> <span class="o">|</span> <span class="n">NTPv4Measurement</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&quot;ntpv5&quot;</span><span class="p">:</span>
            <span class="n">measurement_vs</span> <span class="o">=</span> <span class="n">NTPv5Measurement</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">measured_server_ip</span><span class="o">=</span><span class="n">server_ip</span><span class="p">)</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="s2">&quot;ntpv5&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">measurement_vs</span> <span class="o">=</span> <span class="n">NTPv4Measurement</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">measured_server_ip</span><span class="o">=</span><span class="n">server_ip</span><span class="p">)</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="s2">&quot;ntpv&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">measurement_vs</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">measurement_vs</span><span class="p">,</span> <span class="n">vs</span>
    <span class="c1"># if we did not receive a valid measurement, then we do not save it</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="add_ripe_measurement_id_to_db_measurement">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.add_ripe_measurement_id_to_db_measurement">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_ripe_measurement_id_to_db_measurement</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">AdvancedSettings</span><span class="p">,</span>
                                              <span class="n">m</span><span class="p">:</span> <span class="n">FullMeasurementDN</span> <span class="o">|</span> <span class="n">FullMeasurementIP</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method perform the RIPE measurement.</span>
<span class="sd">    It marked the ripe_error field if there are any errors.</span>
<span class="sd">    Args:</span>
<span class="sd">        db (Session): A connection to the database (we need to query some IDs)</span>
<span class="sd">        server (str): The server (IP address or domain name)</span>
<span class="sd">        settings (AdvancedSettings): The settings to use.</span>
<span class="sd">        m (FullMeasurementDN | FullMeasurementIP): Full measurement IP object.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ripe_measurement_id</span> <span class="o">=</span> <span class="n">perform_ripe_measurement</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">custom_client_ip</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">wanted_ip_type</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">id_ripe</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ripe_measurement_id</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">RipeMeasurementError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RIPE measurement initiated, but it failed. RIPE has a problem: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">ripe_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RIPE measurement initiated, but it failed: </span><span class="si">{</span><span class="n">sanitize_string</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to initiate RIPE measurement: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">ripe_error</span> <span class="o">=</span> <span class="s2">&quot;Failed to initiate RIPE measurement&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>



<div class="viewcode-block" id="fetch_historic_data_with_timestamps">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.fetch_historic_data_with_timestamps">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_historic_data_with_timestamps</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span>
    <span class="n">NtpMeasurement</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches and reconstructs NTP measurements from the database within a specific time range.</span>

<span class="sd">    Converts the provided human-readable datetime range into NTP-compatible timestamps,</span>
<span class="sd">    queries the database based on whether the server is an IP address or domain name,</span>
<span class="sd">    and reconstructs each result as an `NtpMeasurement` object.</span>

<span class="sd">    Args:</span>
<span class="sd">        server (str): An IPv4/IPv6 address or domain name string for which measurements should be fetched.</span>
<span class="sd">        start (datetime): The start of the time range (in local or UTC timezone).</span>
<span class="sd">        end (datetime): The end of the time range (in local or UTC timezone).</span>
<span class="sd">        session (Session): The currently active database session.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[NtpMeasurement]: A list of `NtpMeasurement` objects representing the historical data</span>
<span class="sd">        for the given server within the time window.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The input datetimes are converted to UTC before processing.</span>
<span class="sd">        - IP addresses are validated using the `is_ip_address()` utility function.</span>
<span class="sd">        - Data is fetched using `get_measurements_timestamps_ip` or `get_measurements_timestamps_dn`</span>
<span class="sd">          depending on the server type.</span>
<span class="sd">        - The `PreciseTime` wrapper is used to reconstruct accurate timestamps from database fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_pt</span> <span class="o">=</span> <span class="n">human_date_to_ntp_precise_time</span><span class="p">(</span><span class="n">ensure_utc</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
    <span class="n">end_pt</span> <span class="o">=</span> <span class="n">human_date_to_ntp_precise_time</span><span class="p">(</span><span class="n">ensure_utc</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
    <span class="c1"># print(start_pt)</span>
    <span class="c1"># print(end_pt)</span>
    <span class="c1"># start_pt = PreciseTime(450, 20)</span>
    <span class="c1"># end_pt = PreciseTime(1200, 100)</span>
    <span class="n">measurements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="n">get_measurements_timestamps_ip</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">parse_ip</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="n">get_measurements_timestamps_dn</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">start_pt</span><span class="p">,</span> <span class="n">end_pt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">measurements</span></div>



<div class="viewcode-block" id="fetch_ripe_data">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.fetch_ripe_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_ripe_data</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches and formats NTP measurement data from RIPE Atlas.</span>

<span class="sd">    This function retrieves raw measurement data from the RIPE Atlas API using the given</span>
<span class="sd">    measurement ID, parses it into internal data structures, and formats it into a</span>
<span class="sd">    standardized dictionary format.</span>

<span class="sd">    Args:</span>
<span class="sd">        measurement_id (str): The unique ID of the RIPE Atlas measurement to fetch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[dict]: A list of dictionaries, each representing a formatted NTP measurement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">measurements</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">parse_data_from_ripe_measurement</span><span class="p">(</span><span class="n">get_data_from_ripe_measurement</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">))</span>
    <span class="n">measurements_formated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measurements</span><span class="p">:</span>
        <span class="n">measurements_formated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_ripe_format</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">measurements_formated</span><span class="p">,</span> <span class="n">status</span></div>



<div class="viewcode-block" id="perform_ripe_measurement">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.perform_ripe_measurement">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_ripe_measurement</span><span class="p">(</span><span class="n">ntp_server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">wanted_ip_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate a RIPE Atlas measurement for a given server (IP address or domain name).</span>

<span class="sd">    This function determines whether the provided server is an IP address or a domain name,</span>
<span class="sd">    and triggers the appropriate RIPE measurement.</span>

<span class="sd">    Args:</span>
<span class="sd">        ntp_server (str): The IP address or domain name of the target NTP server.</span>
<span class="sd">        client_ip (Optional[str]): The IP address of the client requesting the measurement.</span>
<span class="sd">        wanted_ip_type (int): The IP type that we want to measure. (4 or 6)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The RIPE measurement ID. (as a string)</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If the server string is invalid or the measurement failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># use our server as the client if the client IP is not provided</span>
    <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="n">ip_to_str</span><span class="p">(</span><span class="n">get_server_ip</span><span class="p">(</span><span class="n">wanted_ip_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;Could not determine IP address of neither server nor client&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_ip_address</span><span class="p">(</span><span class="n">ntp_server</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">measurement_id</span> <span class="o">=</span> <span class="n">perform_ripe_measurement_ip</span><span class="p">(</span><span class="n">ntp_server</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">measurement_id</span> <span class="o">=</span> <span class="n">perform_ripe_measurement_domain_name</span><span class="p">(</span><span class="n">ntp_server</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">wanted_ip_type</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InputError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="n">RipeMeasurementError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_ripe_measurement_scheduled">
<a class="viewcode-back" href="../../../../server.services.html#server.app.services.api_services.check_ripe_measurement_scheduled">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_ripe_measurement_scheduled</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a RIPE Atlas measurement has been fully scheduled.</span>

<span class="sd">    This function delegates to `check_all_measurements_scheduled()` to verify that</span>
<span class="sd">    all requested probes have been scheduled for the given RIPE measurement ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        measurement_id (str): The ID of the RIPE measurement to check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if all requested probes are scheduled, False otherwise.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the RIPE API returns an error or unexpected data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">check_all_measurements_scheduled</span><span class="p">(</span><span class="n">measurement_id</span><span class="o">=</span><span class="n">measurement_id</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TU Delft CSE 2000 Group 15d. Licensed under the MIT License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>